---
title: "Udacity DAND Project 3 - Exploratory Data Analysis"
author: "Dave Rench McCauley"
date: "4/2/2018"
output: html_document
---

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using in your analysis in this code
# chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk. This
# prevents the code from displaying in the knitted HTML output. You should set
# echo=FALSE for all code chunks in your file, unless it makes sense for your
# report to show the code that generated a particular plot.

# The other parameters for "message" and "warning" should also be set to FALSE
# for other code chunks once you have verified that each plot comes out as you
# want it to. This will clean up the flow of your report.

#In order to avoid having to do this for every single chunk in this RMD file,
#I do the following:

#REMOVE COMMENT AT END OF FOLLOWING LINE BEFORE SUBMITTING PROJECT:
knitr::opts_chunk$set(echo=FALSE)#, message=FALSE, warning=FALSE)


library(ggplot2)
```

```{r Load_the_Data}
# Load the Data
full_data <- read.csv("Data/prosperLoanData.csv")
```

```{r Check the data}
str(full_data)
head(full_data)
```


# Introduction

In this project, I'm interested in exploring data from [Prosper](https://www.prosper.com/plp/about/), 
a peer-to-peer lending platform. As this is a huge data set (~114,000 
observations with 81 variables), I'll be limiting myself to a subset of the most interesting variables. It should be noted that the data from this were last updated 3/11/2014. 

In particular, I'm most interested in the following variables (for the reasons included):

Prosper Variable | Why It's Interesting
--- | ---
ListingCreationDate | This is useful for contextualizing the data, especially given the Great Recession of 2008-09
Term | Useful for understanding what time span a borrower felt comfortable with
LoanStatus | This is a primary outcome variable, helping to determine things like Prosper's average default rate and what types of borrowers tend to default
ClosedDate | Useful for knowing what average payoff (and permanent default) timelines look like
BorrowerAPR | This will provide broad context for the cost of the loan, beyond what is provided in BorrowerRate
BorrowerRate | This gives an idea of how much the borrower emphasized monthly payments vs. total loan cost by comparing to LenderYield | This helps me understand what was in it for the lender. I expect that this will be directly 
ListingCategory | This will again be helfpul for contextualizing the data and letting me know what the loan's stated purpose was/is. 
BorrowerState | This may provide interesting extra data in the geographic sense (e.g. comparing loan defaults in a given state with the amount of home foreclosures in that state for the year in question)
EmploymentStatus | A useful categorical variable for determining likelihood and speed of repayment based on existing employment
CreditScoreRangeLower | Provides economic context for the borrowers
CreditScoreRangeUpper | Provides economic context for the borrowers
CreditScoreMidpt | A variable calculated in this project, using the midpoint of the upper and lower credit scores recorded, for reducing variable count in analyses
DelinquenciesLast7Years | Much like other variables here, useful for understanding likelihood of defaults/full repayments of borrowers with differing amounts of historical delinquency.
StatedMonthlyIncome | Provides economic context for the borrowers
LoanOriginalAmount | Important base information about the nature of each loan
MonthlyLoanPayment | Important base information about the nature of each loan

```{r Getting Only the Variables We Care About}
#Let's now subset the loan data so we're only looking at the variables we
#care about

chosen_columns <- c("ListingCreationDate",
                     "Term",
                     "LoanStatus",
                     "ClosedDate",
                     "BorrowerAPR",
                     "BorrowerRate",
                     "LenderYield",
                     "ListingCategory..numeric.",
                     "BorrowerState",
                     "EmploymentStatus",
                     "CreditScoreRangeLower",
                     "CreditScoreRangeUpper",
                     "DelinquenciesLast7Years",
                     "StatedMonthlyIncome",
                     "LoanOriginalAmount",
                     "MonthlyLoanPayment")

#Didn't use subset() here as documentation indicates it is not ideal for
#programmatic use
loans <- full_data[chosen_columns]
head(loans)
```

```{r Cleaning Up the Data}
#Just a little bit more cleaning to do before we're ready to explore

#' Convert numeric ListingCategory values into descriptive strings.
#' 
#' @param x An integer corresponding to a ListingCategory value.
#' @return The listing category string associated with the input numeric
#' @examples
#' cat_num_to_str(2) returns "Home Improvement"
cat_num_to_str <- function(x) {
  allowed_values <- c(0:20)
	if(!(x %in% allowed_values)) {
		stop("The input value is outside allowed range")}
  
  x <- toString(x)
  category_names <- list("0" = "Not Available", 
                         "1" = "Debt Consolidation", 
                         "2" = "Home Improvement", 
                         "3" = "Business", 
                         "4" = "Personal Loan", 
                         "5" = "Student Use", 
                         "6" = "Auto", 
                         "7" = "Other", 
                         "8" = "Baby&Adoption", 
                         "9" = "Boat", 
                         "10" = "Cosmetic Procedure", 
                         "11" = "Engagement Ring", 
                         "12" = "Green Loans", 
                         "13" = "Household Expenses", 
                         "14" = "Large Purchases", 
                         "15" = "Medical/Dental", 
                         "16" = "Motorcycle", 
                         "17" = "RV", 
                         "18" = "Taxes", 
                         "19" = "Vacation", 
                         "20" = "Wedding Loans")
	
  return(category_names[[x]])}


#Apply our function to every value in the ListingCategory...numeric. variable
loans$ListingCategory <- vapply(loans$ListingCategory..numeric., 
                                FUN = "cat_num_to_str", 
                                FUN.VALUE = "")

#Make the newly-created variable ListingCategory into an unordered Factor
loans$ListingCategory <- factor(loans$ListingCategory)

head(loans[c("ListingCategory", "ListingCategory..numeric.")])


#Add in credit score midpoint variable
loans$CreditScoreMidpt <- (loans$CreditScoreRangeLower +
                             loans$CreditScoreRangeUpper) / 2

#We also need to make sure our time series data are recognized by R as time data
#As such, let's use the lubridate package!
library(lubridate)
loans$ListingCreationDate <- ymd_hms(loans$ListingCreationDate)
```



# Univariate Plots Section

Let's take a 1D look at each of our variables first to make sure we understand
what we're working with. We'll start with taking a look at the data set's
structure and size.

```{r Basic Data Characteristics}
str(loans)
```

We are dealing with a data set that contains 113,937 observations (AKA loans) of  18 variables.

## Loans as a Function of Time

```{r Loans Over Time}
ggplot(aes(x = ListingCreationDate), data = loans) +
  #these data are of the type POSIXct and thus the unit it's plotting is
  #actually seconds. Thus, 1 year = 60 sec * 60 min * 24 hr * 365.25 days
  geom_histogram(binwidth = (60 * 60 * 24 * 365.25)/12) +
  scale_x_datetime(date_labels = "%m-%Y", date_breaks = "6 months") +
  theme(axis.text.x  = element_text(angle = 90))
```

This is a strange functional dependence of loan count (per month) over time. It 
looks like business was booming in the Prosper loan marketplace from its 
inception in 2006 until 2009, then it did a hard reset on its business. This 
could be due to a few things:

1. 2008 was the beginning of The Great Recession in the United States. It is
possible that lenders were skiddish about loaning money through new loan
mechanisms like peer-to-peer and, likely, they were skiddish about making loans
in general. Also, borrowers in the Prosper marketplace, much like in many other
American markets at the time, likely also avoided debt as much as possible,
while trying to save cash and pay off pre-existing debts as fast as possible.

2. [According to Prosper's Wikipedia page](https://en.wikipedia.org/wiki/Prosper_Marketplace),
the marketplace faced a class action lawsuit starting in November 2008 that, 
among other things, took issue with the way Prosper managed its loans and the
geographic variability it allowed for in its lenders. As a result, the pre-2009
model Propser had used for setting interest rates on loans (an eBay-style Dutch
auction system wherein lenders could bid on the interest rates and loans) was
replaced with a system wherein Prosper set interest rates itself, using data
it had on hand about the borrower and other elements of the lending ecosystem.
It is possible that this change in business model was jarring to existing users
who then became disenchanted during the adjustment period to the new model.

3. Along the same lines as the preceding point, there is one more possibility:
simple geographic limitation. As part of registering its new model and loans
with the SEC in July 2009, Prosper also limited its pool of allowable lenders
to 28 states in the US and only allowed borrowers from 47 states. While the
Wikipedia article referenced earlier doesn't specify what Prosper's pre-existing
geographic coverage for lenders and borrowers was, it seems likely that it was
broader than the post-2009 coverage, suggesting that Prosper's new model 
effectively locked some of its pre-existing customers out of its marketplace,
which would of course also account for the significant drop in loans in 2009.

While it is certainly possible that The Great Recession caused this drop in 
business we're observing, I think it's far more likely that the lawsuit and
change in business model are mostly to blame. The loan counts from May 2008 to 
November 2008 show a decline, but it is relatively steady in nature. The sudden
zero-ing out of business from November 2008 to May 2009 seems too drastic to
simply chalk up to a strained market.

**A valid question to ask:** is it useful to compare loans made 2006-2008 to
the rest of the portfolio in this data set? For now, I'm going to keep those 
earlier loans, as the Great Recession period likely has interesting elements
that echo throughout the later loans, but we'll need to keep a wary eye on that
time period, given the amount of change that Prosper experienced. For example,
the auction-style rate-setting likely produced defaults at a similar rate to
the later preset rates model, but we should expect a lot more variability in 
rates pre-2009. So it will likely depend upon the variables we choose to use and
may require filtering out earlier loans depending on the impact they have on
our analysis.

## Distribution of Loan Term Lengths

```{r Summary of Loan Term Lengths}

str(loans$Term)
summary(loans$Term)
```


```{r Loan Term Length Distribution}
ggplot(aes(x = Term), data = loans) +
  geom_histogram() + 
  scale_x_continuous(breaks = c(12, 36, 60))
```

Based upon this distribution and the summary data from earlier, it is clear that
there are really only 3 terms available to borrowers: 12, 36, and 60 months. As
such, we'll make this variable into a factor, as any further analysis using this 
variable (e.g. a regression) should not assume`Term` is a continuous variable 
when it really isn't.

```{r Factoring Term Variable}
library(ggthemes)
library(gridExtra)

loans$Term <- factor(loans$Term)

p_term <- ggplot(aes(x = Term), data = loans) +
  geom_bar() +
  scale_y_continuous(limits = c(0,90000))

p_term_fraction <- ggplot(aes(x = Term), data = loans) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = scales::percent,
                     breaks = seq(0,1,0.05))

grid.arrange(p_term, p_term_fraction, ncol = 2)
```

There we go! This is much more intuitive to view than the original 
continuous-variable version. We can now see clearly that 36-month term loans 
comprise about 77% of all loans in our data set, 60-month terms are around 22%, 
leaving only about 1-2% of all loans as 12-month ones.

## Distribution of Loan Status

```{r Summary of Loan Statuses}
str(loans$LoanStatus)
summary(loans$LoanStatus)
```

So we have a bunch of different statuses, included 6 Past Due statuses that are
given further context by the length of delinquency. Note here that "Chargedoff" 
is a term usually applied by the lender to indicate that the loan is Defaulted 
and unlikely to be collected upon. As this is effectively a permanent status, 
it is perhaps unsurprising that it should have the third highest count of 
the statuses, as it can never be turned it another status over time. Let's take
a look at this visually.

```{r Loan Status Distribution}
ggplot(aes(x = LoanStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1))
```

Given how large the differences are between the dominant statuses ("ChargedOff",
"Completed", "Current", and "Defaulted"), let's transform to a log scale, shall
we?

```{r Loan Status Distribution - Log(y)}
ggplot(aes(x = LoanStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous("log_10(count)", 
                     breaks = c(10,100,1000,10000,100000, 50000),
                     trans = scales::log10_trans())
```

The shape of this distribution is now a little more obvious for low signals,
but it still seems like something is missing visually. Let's try making 
`LoanStatus` an ordered factor, with the following ranking (with more positive
loan outcomes being ranked more highly):

Factor Level Rank | Factor Level
--- | ---
1 | Completed
2 | FinalPaymentInProgress
3 | Current
4 | Cancelled
5 | Past Due (1-15 days) 
6 | Past Due (16-30 days)
7 | Past Due (31-60 days)
8 | Past Due (61-90 days)
9 | Past Due (91-120 days)
10 | Past Due (>120 days)
11 | Defaulted
12 | Chargedoff

"Cancelled" is placed in the rankings where it is due to the variety of possible
scenarios in which cancellation could occur. It is not always objectively a
*good* outcome, but is generally viewed as more positive than being past due, 
defaulted, or considered charged off.

```{r Ordering Loan Status Variable}

status_order <- c("Completed", "FinalPaymentInProgress", "Current",
                  "Cancelled", "Past Due (1-15 days)", "Past Due (16-30 days)",
                  "Past Due (31-60 days)", "Past Due (61-90 days)",
                  "Past Due (91-120 days)", "Past Due (>120 days)",
                  "Defaulted", "Chargedoff")

loans$LoanStatus <- factor(loans$LoanStatus, levels = status_order)


levels(loans$LoanStatus)
```

OK, now we've got these statuses ordered the way that is most useful to us,
so let's see how these distributions (linear and log10) change.

```{r Ordered Loan Status Distribution - Linear and Log10}

p_status <- ggplot(aes(x = LoanStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1))

p_status_log <- ggplot(aes(x = LoanStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous("log_10(count)",
                     trans = scales::log10_trans())

grid.arrange(p_status, p_status_log)
```

This is helpful. It's now more clear that the difference in counts in Past Due
loans is not really significant, except for a slightly larger number for the
1-15 days bucket and a slightly smaller number for the >120 days bucket, both
of which are understandable. For the former, it's easy to be slightly late on 
your payments through forgetfulness or a misalignment of your income timeline 
and loan payment timeline. For the latter, I'd expect that many people, when 
informed that they are at risk of being put into Default status, get their 
payments in to avoid being forced to pay off the loan fully in that moment.

# Univariate Analysis

> **Tip**: Now that you've completed your univariate explorations, it's time to
reflect on and summarize what you've found. Use the questions below to help you
gather your observations and add your own if you have other thoughts!

### What is the structure of your dataset?

### What is/are the main feature(s) of interest in your dataset?

### What other features in the dataset do you think will help support your 
###investigation into your feature(s) of interest?

### Did you create any new variables from existing variables in the dataset?

### Of the features you investigated, were there any unusual distributions? 
### Did you perform any operations on the data to tidy, adjust, or change the 
### form of the data? If so, why did you do this?


# Bivariate Plots Section

> **Tip**: Based on what you saw in the univariate plots, what relationships
between variables might be interesting to look at in this section? Don't limit
yourself to relationships between a main output feature and one of the
supporting variables. Try to look at relationships between supporting variables
as well.

```{r echo=FALSE, Bivariate_Plots}

```

# Bivariate Analysis

> **Tip**: As before, summarize what you found in your bivariate explorations
here. Use the questions below to guide your discussion.

### Talk about some of the relationships you observed in this part of the \
investigation. How did the feature(s) of interest vary with other features in \
the dataset?

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

### What was the strongest relationship you found?


# Multivariate Plots Section

> **Tip**: Now it's time to put everything together. Based on what you found in
the bivariate plots section, create a few multivariate plots to investigate
more complex interactions between variables. Make sure that the plots that you
create here are justified by the plots you explored in the previous section. If
you plan on creating any mathematical models, this is the section where you
will do that.

```{r echo=FALSE, Multivariate_Plots}

```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. Were there features that strengthened each other in terms of \
looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the \
strengths and limitations of your model.

------

# Final Plots and Summary

> **Tip**: You've done a lot of exploration and have built up an understanding
of the structure of and relationships between the variables in your dataset.
Here, you will select three plots from all of your previous exploration to
present here as a summary of some of your most interesting findings. Make sure
that you have refined your selected plots for good titling, axis labels (with
units), and good aesthetic choices (e.g. color, transparency). After each plot,
make sure you justify why you chose each plot by describing what it shows.

### Plot One
```{r echo=FALSE, Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

```

### Description Three

------

# Reflection

> **Tip**: Here's the final step! Reflect on the exploration you performed and
the insights you found. What were some of the struggles that you went through?
What went well? What was surprising? Make sure you include an insight into
future work that could be done with the dataset.

> **Tip**: Don't forget to remove this, and the other **Tip** sections before
saving your final work and knitting the final report!