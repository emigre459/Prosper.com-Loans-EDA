---
title: "Udacity DAND Project 3 - Exploratory Data Analysis"
author: "Dave Rench McCauley"
date: "4/2/2018"
output: html_document
---

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using in your analysis in this code
# chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk. This
# prevents the code from displaying in the knitted HTML output. You should set
# echo=FALSE for all code chunks in your file, unless it makes sense for your
# report to show the code that generated a particular plot.

# The other parameters for "message" and "warning" should also be set to FALSE
# for other code chunks once you have verified that each plot comes out as you
# want it to. This will clean up the flow of your report.

#In order to avoid having to do this for every single chunk in this RMD file,
#I do the following:

#REMOVE COMMENT AT END OF FOLLOWING LINE BEFORE SUBMITTING PROJECT:
knitr::opts_chunk$set(echo=FALSE)#, message=FALSE, warning=FALSE)


library(ggplot2)
```

```{r Load_the_Data}
# Load the Data
full_data <- read.csv("Data/prosperLoanData.csv")
```

```{r Check the data}
str(full_data)
head(full_data)
```


# Introduction

In this project, I'm interested in exploring data from [Prosper](https://www.prosper.com/plp/about/), 
a peer-to-peer lending platform. As this is a huge data set (~114,000 
observations with 81 variables), I'll be limiting myself to a subset of the most interesting variables. It should be noted that the data from this were last updated 3/11/2014. 

In particular, I'm most interested in the following variables (for the reasons included):

Prosper Variable | Why It's Interesting
--- | ---
ListingCreationDate | This is useful for contextualizing the data, especially given the Great Recession of 2008-09
Term | Useful for understanding what time span a borrower felt comfortable with
LoanStatus | This is a primary outcome variable, helping to determine things like Prosper's average default rate and what types of borrowers tend to default
ClosedDate | Useful for knowing what average payoff (and permanent default) timelines look like
BorrowerAPR | This will provide broad context for the cost of the loan, beyond what is provided in BorrowerRate
BorrowerRate | This gives an idea of how much the borrower emphasized monthly payments vs. total loan cost by comparing to LenderYield | This helps me understand what was in it for the lender. I expect that this will be directly 
ListingCategory | This will again be helfpul for contextualizing the data and letting me know what the loan's stated purpose was/is. 
BorrowerState | This may provide interesting extra data in the geographic sense (e.g. comparing loan defaults in a given state with the amount of home foreclosures in that state for the year in question)
EmploymentStatus | A useful categorical variable for determining likelihood and speed of repayment based on existing employment
CreditScoreRangeLower | Provides economic context for the borrowers
CreditScoreRangeUpper | Provides economic context for the borrowers
CreditScoreMidpt | A variable calculated in this project, using the midpoint of the upper and lower credit scores recorded, for reducing variable count in analyses
DelinquenciesLast7Years | Much like other variables here, useful for understanding likelihood of defaults/full repayments of borrowers with differing amounts of historical delinquency.
StatedMonthlyIncome | Provides economic context for the borrowers
LoanOriginalAmount | Important base information about the nature of each loan
MonthlyLoanPayment | Important base information about the nature of each loan

```{r Getting Only the Variables We Care About}
#Let's now subset the loan data so we're only looking at the variables we
#care about

chosen_columns <- c("ListingCreationDate",
                     "Term",
                     "LoanStatus",
                     "ClosedDate",
                     "BorrowerAPR",
                     "BorrowerRate",
                     "LenderYield",
                     "ListingCategory..numeric.",
                     "BorrowerState",
                     "EmploymentStatus",
                     "CreditScoreRangeLower",
                     "CreditScoreRangeUpper",
                     "DelinquenciesLast7Years",
                     "StatedMonthlyIncome",
                     "LoanOriginalAmount",
                     "MonthlyLoanPayment")

#Didn't use subset() here as documentation indicates it is not ideal for
#programmatic use
loans <- full_data[chosen_columns]
head(loans)
```

```{r Cleaning Up the Data}
#Just a little bit more cleaning to do before we're ready to explore

#' Convert numeric ListingCategory values into descriptive strings.
#' 
#' @param x An integer corresponding to a ListingCategory value.
#' @return The listing category string associated with the input numeric
#' @examples
#' cat_num_to_str(2) returns "Home Improvement"
cat_num_to_str <- function(x) {
  allowed_values <- c(0:20)
	if(!(x %in% allowed_values)) {
		stop("The input value is outside allowed range")}
  
  x <- toString(x)
  category_names <- list("0" = "Not Available", 
                         "1" = "Debt Consolidation", 
                         "2" = "Home Improvement", 
                         "3" = "Business", 
                         "4" = "Personal Loan", 
                         "5" = "Student Use", 
                         "6" = "Auto", 
                         "7" = "Other", 
                         "8" = "Baby&Adoption", 
                         "9" = "Boat", 
                         "10" = "Cosmetic Procedure", 
                         "11" = "Engagement Ring", 
                         "12" = "Green Loans", 
                         "13" = "Household Expenses", 
                         "14" = "Large Purchases", 
                         "15" = "Medical/Dental", 
                         "16" = "Motorcycle", 
                         "17" = "RV", 
                         "18" = "Taxes", 
                         "19" = "Vacation", 
                         "20" = "Wedding Loans")
	
  return(category_names[[x]])}


#Apply our function to every value in the ListingCategory...numeric. variable
loans$ListingCategory <- vapply(loans$ListingCategory..numeric., 
                                FUN = "cat_num_to_str", 
                                FUN.VALUE = "")

#Make the newly-created variable ListingCategory into an unordered Factor
loans$ListingCategory <- factor(loans$ListingCategory)

head(loans[c("ListingCategory", "ListingCategory..numeric.")])


#Add in credit score midpoint variable
loans$CreditScoreMidpt <- (loans$CreditScoreRangeLower +
                             loans$CreditScoreRangeUpper) / 2

#We also need to make sure our time series data are recognized by R as time data
#As such, let's use the lubridate package!
library(lubridate)
loans$ListingCreationDate <- ymd_hms(loans$ListingCreationDate)

```



# Univariate Plots Section

Let's take a 1D look at each of our variables first to make sure we understand
what we're working with. We'll start with taking a look at the data set's
structure and size.

```{r Basic Data Characteristics}
str(loans)
```

We are dealing with a data set that contains 113,937 observations (AKA loans) of  18 variables.

## Loans as a Function of Time

```{r Loans Over Time}
p_listingDate <- ggplot(aes(x = ListingCreationDate), data = loans) +
  #these data are of the type POSIXct and thus the unit it's plotting is
  #actually seconds. Thus, 1 year = 60 sec * 60 min * 24 hr * 365.25 days
  geom_histogram(binwidth = (60 * 60 * 24 * 365.25)/12) +
  scale_x_datetime(date_labels = "%m-%Y", date_breaks = "6 months") +
  theme(axis.text.x  = element_text(angle = 90))

p_listingDate
```

This is a strange functional dependence of loan count (per month) over time. It 
looks like business was booming in the Prosper loan marketplace from its 
inception in 2006 until 2009, then it did a hard reset on its business. This 
could be due to a few things:

1. 2008 was the beginning of The Great Recession in the United States. It is
possible that lenders were skiddish about loaning money through new loan
mechanisms like peer-to-peer and, likely, they were skiddish about making loans
in general. Also, borrowers in the Prosper marketplace, much like in many other
American markets at the time, likely also avoided debt as much as possible,
while trying to save cash and pay off pre-existing debts as fast as possible.

2. [According to Prosper's Wikipedia page](https://en.wikipedia.org/wiki/Prosper_Marketplace),
the marketplace faced a class action lawsuit starting in November 2008 that, 
among other things, took issue with the way Prosper managed its loans and the
geographic variability it allowed for in its lenders. As a result, the pre-2009
model Propser had used for setting interest rates on loans (an eBay-style Dutch
auction system wherein lenders could bid on the interest rates and loans) was
replaced with a system wherein Prosper set interest rates itself, using data
it had on hand about the borrower and other elements of the lending ecosystem.
It is possible that this change in business model was jarring to existing users
who then became disenchanted during the adjustment period to the new model.

3. Along the same lines as the preceding point, there is one more possibility:
simple geographic limitation. As part of registering its new model and loans
with the SEC in July 2009, Prosper also limited its pool of allowable lenders
to 28 states in the US and only allowed borrowers from 47 states. While the
Wikipedia article referenced earlier doesn't specify what Prosper's pre-existing
geographic coverage for lenders and borrowers was, it seems likely that it was
broader than the post-2009 coverage, suggesting that Prosper's new model 
effectively locked some of its pre-existing customers out of its marketplace,
which would of course also account for the significant drop in loans in 2009.

While it is certainly possible that The Great Recession caused this drop in 
business we're observing, I think it's far more likely that the lawsuit and
change in business model are mostly to blame. The loan counts from May 2008 to 
November 2008 show a decline, but it is relatively steady in nature. The sudden
zero-ing out of business from November 2008 to May 2009 seems too drastic to
simply chalk up to a strained market.

**A valid question to ask:** is it useful to compare loans made 2006-2008 to
the rest of the portfolio in this data set? For now, I'm going to keep those 
earlier loans, as the Great Recession period likely has interesting elements
that echo throughout the later loans, but we'll need to keep a wary eye on that
time period, given the amount of change that Prosper experienced. For example,
the auction-style rate-setting likely produced defaults at a similar rate to
the later preset rates model, but we should expect a lot more variability in 
rates pre-2009. So it will likely depend upon the variables we choose to use and
may require filtering out earlier loans depending on the impact they have on
our analysis.

While it seems fairly likely that we've explained the 2008 oddity in
`ListingCreationDate` here, I do still wonder about the late-2012/early-2013 dip 
in loans. My research thus far has not indicated a good reason why this may have 
occurred. Some additional investor funding in Prosper as a company occurred 
during this time, but there are other (smaller and bigger) rounds of investing 
that occurred outside of that time period, so that doesn't seem like a 
sufficient explanation. 

## Distribution of Loan Term Lengths

```{r Summary of Loan Term Lengths}

str(loans$Term)
summary(loans$Term)
```


```{r Loan Term Length Distribution}
ggplot(aes(x = Term), data = loans) +
  geom_histogram() + 
  scale_x_continuous(breaks = c(12, 36, 60))
```

Based upon this distribution and the summary data from earlier, it is clear that
there are really only 3 terms available to borrowers: 12, 36, and 60 months. As
such, we'll make this variable into an ordered factor, as any further analysis
using this variable (e.g. a regression) should not assume `Term` is a continuous 
variable when it really isn't.

```{r Factoring Term Variable}
library(ggthemes)
library(gridExtra)

loans$Term <- factor(loans$Term, levels = c(12, 36, 60), ordered = TRUE)

p_term <- ggplot(aes(x = Term), data = loans) +
  geom_bar() +
  scale_y_continuous(limits = c(0,90000))

p_term_fraction <- ggplot(aes(x = Term), data = loans) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels = scales::percent,
                     breaks = seq(0,1,0.05))

grid.arrange(p_term, p_term_fraction, ncol = 2)
```

There we go! This is much more intuitive to view than the original 
continuous-variable version. We can now see clearly that 36-month term loans 
comprise about 77% of all loans in our data set, 60-month terms are around 22%, 
leaving only about 1-2% of all loans as 12-month ones.

## Distribution of Loan Status

```{r Summary of Loan Statuses}
str(loans$LoanStatus)
summary(loans$LoanStatus)
```

So we have a bunch of different statuses, including 6 Past Due statuses that are
given further context by the length of delinquency. Note here that "Chargedoff" 
is a term usually applied by the lender to indicate that the loan is Defaulted 
and unlikely to be collected upon. As this is effectively a permanent status, 
it is perhaps unsurprising that it should have the third highest count of 
the statuses, as it can never be turned into another status over time. Let's take
a look at this visually.

```{r Loan Status Distribution}
ggplot(aes(x = LoanStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1))
```

Given how large the differences are between the dominant statuses ("ChargedOff",
"Completed", "Current", and "Defaulted"), let's transform to a log scale, shall
we?

```{r Loan Status Distribution - Log(y)}
ggplot(aes(x = LoanStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous("log_10(count)", 
                     breaks = c(10,100,1000,10000,100000, 50000),
                     trans = scales::log10_trans())
```

The shape of this distribution is now a little more obvious for low signals,
but it still seems like something is missing visually. Let's try making 
`LoanStatus` an ordered factor, with the following ranking (with more positive
loan outcomes being ranked more highly and thereby receiving a lower Factor Level Rank):

Factor Level Rank | Factor Level
--- | ---
1 | Completed
2 | FinalPaymentInProgress
3 | Current
4 | Cancelled
5 | Past Due (1-15 days) 
6 | Past Due (16-30 days)
7 | Past Due (31-60 days)
8 | Past Due (61-90 days)
9 | Past Due (91-120 days)
10 | Past Due (>120 days)
11 | Defaulted
12 | Chargedoff

"Cancelled" is placed in the rankings where it is due to the variety of possible
scenarios in which cancellation could occur. It is not always objectively a
*good* outcome, but is generally viewed as more positive than being past due, 
defaulted, or considered charged off.

```{r Ordering Loan Status Variable}

status_order <- c("Completed", "FinalPaymentInProgress", "Current",
                  "Cancelled", "Past Due (1-15 days)", "Past Due (16-30 days)",
                  "Past Due (31-60 days)", "Past Due (61-90 days)",
                  "Past Due (91-120 days)", "Past Due (>120 days)",
                  "Defaulted", "Chargedoff")

#Need the most negative categorical value to go first, not the other way around
status_order <- rev(status_order)

loans$LoanStatus <- factor(loans$LoanStatus, levels = status_order, 
                           ordered = TRUE)


levels(loans$LoanStatus)
```

OK, now we've got these statuses ordered the way that is most useful to us,
so let's see how these distributions (linear and log10) change.

```{r Ordered Loan Status Distribution - Linear and Log10}

p_status <- ggplot(aes(x = LoanStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1))

p_status_log <- ggplot(aes(x = LoanStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous("log_10(count)",
                     trans = scales::log10_trans())

p_status
```

```{r}
p_status_log
```


This is helpful. It's now more clear that the difference in counts in Past Due
loans is not really significant, except for a slightly larger number for the
1-15 days bucket and a slightly smaller number for the >120 days bucket, both
of which are understandable. For the former, it's easy to be slightly late on 
your payments through forgetfulness or a misalignment of your income timeline 
and loan payment timeline. For the latter, I'd expect that many people, when 
informed that they are at risk of being put into Default status, get their 
payments in to avoid being forced to pay off the loan fully in that moment.

## Distribution of Closed Date

First, we need to convert closing dates from a factor with string levels to 
date and time values that R recognizes, like we did with the loan listing dates.

```{r Convert Closing Dates to Be A Date Variable}
loans$ClosedDate <- ymd_hms(loans$ClosedDate)
str(loans$ClosedDate)
```

OK, time to plot this up!

```{r Distribution of Closing Dates}
p_closedDate <- ggplot(aes(x = ClosedDate), data = loans) +
  #these data are of the type POSIXct and thus the unit it's plotting is
  #actually seconds. Thus, 1 year = 60 sec * 60 min * 24 hr * 365.25 days
  geom_histogram(binwidth = (60 * 60 * 24 * 365.25)/12) +
  scale_x_datetime(date_labels = "%m-%Y", date_breaks = "6 months") +
  theme(axis.text.x  = element_text(angle = 90)) +
  ggtitle("Closing Dates")

p_closedDate
```

```{r}
p_listingDate + ggtitle("Listing Creation Dates")
```

At first glance, the closing dates distribution doesn't make a lot of sense. Why
don't we see a sudden dropoff in 2008-2009 like we did with the listing creation
dates? And why are the numbers for this distribution so much lower? The key here
is that only a subset (and clearly a limited one at that - 48.4% here) of the 
entire loan portfolio would have a closing date (only those with a status of 
Cancelled, Completed, Chargedoff, or Defaulted in fact). While these are a large 
portion of the portfolio, they are certainly not the entirety of it, explaining 
the significantly lower counts. And we can see a dip in the close dates around 
12/2011. Given that we know more than 75% of the loans have 3 year terms, this
dropoff shouldn't suprise us: this is almost exactly 3 years after the 2008-2009
dropoff in listing creations. 

## Distribution of Borrower APRs and Rates

As the APR (Annual Percentage Rate) and the base interest rate of loans are
considered linked (with the APR simply taking into account origination and
maintenance costs of the loan that the base rate does not), I decided to explore
these together.

```{r Distribution of APR}
p_APR <- ggplot(aes(x = BorrowerAPR), data = loans) +
  geom_histogram(binwidth = 0.005) +
  scale_x_continuous(breaks = seq(0,0.5,0.025), labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#We'll define the center of the broad peak here as being the median value for
#all APRs less than 35%
peak_midpt_APR <- median(na.omit(loans$BorrowerAPR[loans$BorrowerAPR < 0.35]))

p_APR + 
  geom_vline(color = "red", 
                   xintercept = peak_midpt_APR) +
  geom_vline(color = "green", xintercept = 0.357)
```

Oddly enough, it seems like we have a broad peak at 20.05% (defined by the 
median of the APRs below 35%) and a narrow jump at 35.7%. Yikes, those are some high rates!

```{r Distribution of Rates}
p_Rate <- ggplot(aes(x = BorrowerRate), data = loans) +
  geom_histogram(binwidth = 0.005) +
  scale_x_continuous(breaks = seq(0,0.5,0.025), labels = scales::percent,
                     limits = c(0, 0.4)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#We'll define the center of the first broad peak here as being the median value 
#for all Rates less than 22.5% and the second for 22.5% <= Rates < 31%
peak_midpt_Rate_1 <- median(na.omit(loans$BorrowerRate[loans$BorrowerRate < 0.225]))

peak_midpt_Rate_2 <- median(na.omit(loans$BorrowerRate[loans$BorrowerRate < 0.31
                                                       & loans$BorrowerRate >= 0.225]))


p_Rate + 
  geom_vline(color = "red", 
             xintercept = peak_midpt_Rate_1) +
  geom_vline(color = "blue", 
             xintercept = peak_midpt_Rate_2) +
  geom_vline(color = "green", xintercept = 0.32)
```

Oddly enough, it seems like we have a broad peak at 14.99% (defined by the 
median of the APRs below 22.5%), another broad peak at 26.24% (this time defined
by the median of the Rates between 22.5% and 31%) and a narrow jump at 32%. As 
we had guessed, these values are lower than the APR values, as they reflect only
the bare interest rates of the loans, not the total cost of origination and
maintenance too. 

What's interesting is the functional form however - why are there so many peaks
and some high-rate delta functions? Perhaps the answer lies in the time series 
data. Let's take a look at these same data, but from pre- and post-2009.

```{r APRs and Rates in Different Time Periods}
p_APR_pre2009 <- ggplot(aes(x = BorrowerAPR), 
                        data = subset(loans, ListingCreationDate < 
                                        ymd("09-01-01"))) +
  geom_histogram(binwidth = 0.005) +
  scale_x_continuous(breaks = seq(0,0.5,0.025), labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Pre-2009 APRs")

p_APR_post2009 <- ggplot(aes(x = BorrowerAPR), 
                        data = subset(loans, ListingCreationDate >= 
                                        ymd("09-01-01"))) +
  geom_histogram(binwidth = 0.005) +
  scale_x_continuous(breaks = seq(0,0.5,0.025), labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("2009 and Later APRs")

p_Rate_pre2009 <- ggplot(aes(x = BorrowerRate), 
                         data = subset(loans, ListingCreationDate < 
                                         ymd("09-01-01"))) +
  geom_histogram(binwidth = 0.005) +
  scale_x_continuous(breaks = seq(0,0.5,0.025), labels = scales::percent,
                     limits = c(0, 0.4)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Pre-2009 Rates")

p_Rate_post2009 <- ggplot(aes(x = BorrowerRate), 
                         data = subset(loans, ListingCreationDate >= 
                                         ymd("09-01-01"))) +
  geom_histogram(binwidth = 0.005) +
  scale_x_continuous(breaks = seq(0,0.5,0.025), labels = scales::percent,
                     limits = c(0, 0.4)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("2009 and Later Rates")

grid.arrange(p_APR_pre2009, p_APR_post2009, p_Rate_pre2009, p_Rate_post2009,
             ncol = 2)
```

How strange! I had expected that some of the features would disappear in one time period or the other, but both exhibit this low-rate broad peak and high-rate
spikes. I'm not sure what would be causing that, but it is interesting to note
that the overall trends of both rate types seem to be smoother in 2009 and 
later, perhaps as a result of the new rate-setting mechansim Prosper employed.
However, that time period also has more data points, so the smoothing could just
be a reflection of the size of the sample (although with 29,056 loans/25.5% of the total data set we're working with listing prior to 1/1/2009, it seems like the sample size would be more than sufficient).

## Lender Yield

Let's now explore how well lenders did in allowing their money to be borrowed out through the Prosper platform.

```{r Summary of Lender Yields}
print("Structure and Summary Statistics of LenderYield")
str(loans$LenderYield)
summary(loans$LenderYield)
```

```{r Distribution of Lender Yields}
p_Yield <- ggplot(aes(x = LenderYield), data = loans) +
  geom_histogram(binwidth = 0.005) +
  scale_x_continuous(breaks = seq(0,0.5,0.025), labels = scales::percent,
                     limits = c(0, 0.4)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

grid.arrange(p_Yield, p_Rate)
```

These look...extremely similar. In fact, a look at the data catalog makes us 
realize that the lender yield is a calculation that simply subtracts the 
servicing fee from the interest rate of a given loan. We would thus expect a
perfect correlation between these variables. We'll make sure to test that in
section on Bivariate Plots/Analysis.

## Listing Category

As we've done previously, here we'll inspect the structure of the data, run
some summary statistics, and generate a basic plot to make sure we know what 
we're looking at. As we've already gone through the trouble of providing human-
readable values for this variable, we won't bother investigating the numeric
version of this variable.

```{r Summary of Listing Category}
str(loans$ListingCategory)
summary(loans$ListingCategory)
```

```{r Distribution of Listing Category}
p_ListCat <- ggplot(aes(x = ListingCategory), data = loans) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))

p_ListCat
p_ListCat + scale_y_log10("Log_10(count)")
```

```{r Ranking Loan Categories}
print("What is the ranking of these categories, from least count to greatest?")
levels(reorder(loans$ListingCategory, loans$ListingCategory, FUN = length))
```

We can see in the linear and log-transformed plots here that by far the most
common use for these loans is debt consolidation, even if the next-highest-count
category had all of the Not Available and Other counts added to it. Speaking of,
these are the categories with the next highest counts, resp., which really isn't
that surprising since they are catch-all categories. 

When only considering explicit categories (in other words, not Not Available or
Other), the top 5 in descending order are:

1. Debt Consolidation
2. Home Improvement
3. Business
4. Auto
5. Personal Loan

I don't see anything particularly surprising about this. If anything, the
biggest surprise to me out of all of this is that Wedding Loans and Engagement
Ring rank higher in frequency than Baby&Adoption. Anyone with kids knows that
they are far more expensive than the vast majority of weddings and rings!

## Borrower State

Let's take a look at some geographic diversity aspects of these loans.

```{r Summary of BorrowerState}
str(loans$BorrowerState)
summary(loans$BorrowerState)

print("Loans by state, ordered by increasing frequency")
levels(reorder(loans$BorrowerState, loans$BorrowerState, FUN = length))
```

```{r Distribution of BorrowerStates}
ggplot(aes(x = BorrowerState), data = loans) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))
```

There are clearly some states dominating the borrower landscape here. However,
I wonder: is this dominance in borrower count a result of simply population
differences between the states, or something else (e.g. CA is where Prosper is
headquartered and CA residents always love to jump on the newest tech 
bandwagon as soon as possible).  Normalizing these data by state population 
(in other words, number of loans per capita) is something we'll tackle in the
bivariate analysis section of this report. Stay tuned!

## Employment Status

Let's take a look at the structure and distribution of another interesting
explanatory variable: borrowers' employment statuses.

```{r Structure and Summary of EmploymentStatus}
str(loans$EmploymentStatus)
summary(loans$EmploymentStatus)
```

It looks like this variable may be a tad tricky, as one would expect that 
"Full-time", "Part-time", and "Self-employed" would all be part of the set 
"Employed" but they're treated as separate levels. Likely this means that 
Prosper started asking for more (or less) detail about employment status as 
time went on. Let's plan to investigate this variable over time in the bivariate
analysis section.

```{r Distribution of EmploymentStatus}
ggplot(aes(x = EmploymentStatus), data = loans) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

By far, the borrowers were employed, and (even though Employed is a pretty
low-resolution value for this variable) likely those who are just employed are
full-time. Later we'll take a look at the correlation between employment types 
and loan status, as it seems plausible that those who are employed full-time 
will find it easier to make payments on time and close their accounts in good 
standing.

## Credit Scores

Now we'll explore the credit scores of different borrowers. As these were 
provided in the original data set as upper and lower ends of ranges, I chose to
create a variable in the data frame that was the midpoint value of each range, 
to simplify analysis without losing resolution. Even though there are a limited
number of possible values for this variable, I chose to keep it as a numeric
instead of a factor, so regression analysis could be done if desired.

```{r Structure and Summary of CreditScoreMidpt}
str(loans$CreditScoreMidpt)
summary(loans$CreditScoreMidpt)
```

```{r Distribution of Credit Scores}
ggplot(data = loans, aes(x = CreditScoreMidpt)) +
  geom_histogram(binwidth = 20) +
  scale_x_continuous(breaks = seq(0, 900, 40)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data = loans, aes(x = CreditScoreMidpt)) +
  geom_histogram(binwidth = 20) +
  scale_x_continuous(limits = c(400,900),
                     breaks = seq(0, max(900), 40))
```

It's not entirely obvious why there are values near zero here, likely that's
an artifact of faulty data (e.g. a missing digit from the credit reporting
agency or poor manual data entry). We ignore that unlikely outlier and zoom in
on the 400 to 900 range.

In the zoomed in range, we see an interesting and somewhat unexepcted 
distriution of credit scores. It looks like there's a small spike in loans for
those with credit scores in the 520 - 540 range, but the main peak is at 680
(unsurprising, since our early descriptive summary analysis indicates a median 
of 689). This is not such a strange result, [as the average American credit score in 2017 was 700.](http://time.com/money/5112478/average-credit-score-by-age/)

## Delinquencies

Another interesting potential predictor of loan payments and successful loan
completion is borrower historic credit delinquencies. Let's take a look at that.

```{r Structure and Summary of DelinquenciesLast7Years}
str(loans$DelinquenciesLast7Years)
summary(loans$DelinquenciesLast7Years)
```

```{r Distribution of DelinquenciesLast7Years}
ggplot(data = loans, aes(x = DelinquenciesLast7Years)) +
  geom_histogram(binwidth = 1, aes(y = ..count../sum(..count..))) +
  scale_y_continuous(breaks = seq(0,0.7,0.1))
```

Clearly, a majority of borrowers had no delinquencies on their records. This is
some seriously long-tailed data. Let's do a log10 transform to see what's really
going on here.

```{r Log-scale Distribution of DelinquenciesLast7Years}
ggplot(data = loans, aes(x = DelinquenciesLast7Years)) +
  geom_histogram(binwidth = 1) +
  scale_y_continuous("log_10(count)", trans = scales::log10_trans())
```

How odd! Why would there be a such an up-tick in delinquencies at the value 99?
Likely this is a reporting artifact (e.g. credit bureaus only reported 99 for
borrowers with 99+ delinquencies). A quick Googling doesn't shed much light on
this, but given that the trend is quite smooth on a log-scale down to 98, I'm
willing to assume that this isn't a meaningful data point. Interestingly, while
credit scores are pretty normally distributed in this group, delinquencies are
not. This likely indicates that delinquencies have a strongly negative effect
on scores, given that the majority of our borrowers have no delinquencies on
record. But really, we don't have sufficient data for that, we'd need to do
a correlational analysis on credit scores and delinquencies. Don't worry - we'll
do just that soon enough!

## Borrowers' Monthly Incomes

Another interesting explantory variable - monthly income. This is a nice
continuous variable that can give us more resolution than `EmploymentStatus`
when it comes to things like loan payment status. Let's dig into it.

```{r Summary and Structure of StatedMonthlyIncome}
str(loans$StatedMonthlyIncome)
summary(loans$StatedMonthlyIncome)
```

```{r Distribution of StatedMonthlyIncome}
ggplot(data = loans, aes(x = StatedMonthlyIncome)) +
  geom_histogram(binwidth = 1000) +
  scale_x_continuous(breaks = seq(0,2E6,1E5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))

ggplot(data = loans, aes(x = StatedMonthlyIncome)) +
  geom_histogram(binwidth = 1000) +
  scale_x_continuous(breaks = seq(0,2E6,1E5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4)) +
  scale_y_log10("Log_10(count)")
```

These data clearly have some outliers. Using the standard definition of an
outlier as being data with values >= 1.5 * IQR + 3rd_quartile, we find that 
outliers here are defined as being greater than $12262.50. Let's look at some
plots limiting ourselves to that.

```{r Distribution of StatedMonthlyIncome - Zoomed}

ggplot(data = loans, aes(x = StatedMonthlyIncome)) +
  geom_histogram(binwidth = 200) +
  scale_x_continuous(limits = c(0,12262.50), breaks = seq(0,12262.50,1000)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4)) +
  geom_vline(xintercept = 4000, color = "red")

ggplot(data = loans, aes(x = StatedMonthlyIncome)) +
  geom_histogram(binwidth = 200) +
  scale_x_continuous(limits = c(0,12262.50), breaks = seq(0,12262.50,1000)) +
  scale_y_log10("Log_10(count)") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))
```

Taking this outlier definition results in a loss of about 5% of the records,
which seems reasonable for exploratory purposes. Given that only about 
[15% of US households make more than this](https://www.statista.com/statistics/203183/percentage-distribution-of-household-income-in-the-us/), 
I think it's a pretty reasonable cutoff for our purposes. There's not too much
that stands out in these data, other than the pretty regular spikes every $400.
Perhaps this has something to do with the human tendency to round to the nearest
500 or 1000? That's not clear.

Also, I should note that the peak of this variable is around 4000, although
this is a bit further removed from the median value of 4667 than I was expecting.

## Amount Loaned

In order to understand the nature of the loans in our data set, we should also
probably know how much each was worth!

```{r Structure and Summary of LoanOriginalAmount}
str(loans$LoanOriginalAmount)
summary(loans$LoanOriginalAmount)
```

```{r Distribution of LoanOriginalAmount}
ggplot(data = loans, aes(x = LoanOriginalAmount)) +
  geom_histogram(binwidth = 500) +
  scale_x_continuous(breaks = seq(0,35000,1000)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))
```

There are peaks at \$10000, \$15000, and \$25000 - none of these are particularly
suprising, given how nice and round those values are. They were likely just a 
stab in the dark by the borrower regarding how much they actually needed. The
surprising data point though, is also the largest peak: \$4000. What is so 
common of an item/service that it requires a \$4000 loan? Given that the largest
loan category was debt consolidation, perhaps \$4000 is a popular limit to put
on revolving debt (e.g. credit cards)? That doesn't seem to explain it, as
the [average credit card limit in 2015 was \$8042](https://smartasset.com/credit-cards/the-average-credit-card-limit).
How curious.

## Monthly Payments

We now finally come to our final variable of interest, the monthly amount due
on the loans. I expect that this will correlate strongly with the loan principal
and also likely the monthly borrower income. For now, though, let's just look
at its overall spread in our portfolio of loans.

```{r Summary and Structure of MonthlyLoanPayment}
str(loans$MonthlyLoanPayment)
summary(loans$MonthlyLoanPayment)
```

```{r Distribution of MonthlyLoanPayment}
ggplot(data = loans, aes(x = MonthlyLoanPayment)) +
  geom_histogram(binwidth = 25) +
  scale_x_continuous(breaks = seq(0,2251.5,100)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))

ggplot(data = loans, aes(x = MonthlyLoanPayment)) +
  geom_histogram(binwidth = 25) +
  scale_x_continuous(breaks = seq(0,2251.5,100)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4)) +
  scale_y_log10("Log_10(count)")
```

Oddly enough, this seems multi-modal with peaks at \$200, \$400, \$525, \$850,
\$1150, and \$1350. I don't really know what to make of those peaks, but perhaps
our work with more than one variable will illuminate this pattern a bit more
(e.g. looking at monthly payment vs. APR).


# Univariate Analysis

### What is the structure of your dataset?

It is a data set of 113,937 observations (loans) and 18 variables. The variables
are (grouped whenever they are related):

1. ListingCreationDate
2. Term
3. ClosedDate
4. LoanStatus
5. BorrowerAPR and BorrowerRate
6. LenderYield
7. ListingCategory and ListingCategory..numeric.
8. BorrowerState
9. EmploymentStatus
10. CreditScoreRangeLower, CreditScoreRangeUpper, and CreditScoreMidpt
11. DelinquenciesLast7Years
12. StatedMonthlyIncome
13. LoanOriginalAmount
14. MonthlyLoanPayment

ListingCategory, EmploymentStatus, and BorrowerState are unordered factors;
Term and LoanStatus are ordered factors. The levels of them are as follows:

* ListingCategory: 21 types of end-uses for loans, including things like Debt Consolidation, Baby&Adoption, and Engagement Ring.
* EmploymentStatus: "", Employed, Full-Time, Not Available, Not employed, Other, Part-time, Retired, and Self-employed
* BorrowerState: all 50 US states + Puerto Rico and Washington, DC
* Term: 12 < 36 < 60 (all in units of months)
* LoanStatus: ordered as follows (least to greatest)
  * Chargedoff
  * Defaulted
  * Past Due (>120 days)
  * Past Due (91-120 days)
  * Past Due (61-90 days)  
  * Past Due (31-60 days)
  * Past Due (16-30 days)
  * Past Due (1-15 days)
  * Cancelled
  * Current
  * FinalPaymentInProgress
  * Completed
  

### What is/are the main feature(s) of interest in your dataset?

The main features I'm most interested in are the loan statuses (trying to understand what characteristics tend to make for a well-paid or delinquent loan) and the listing date for each loan, given the complete drop in loans as of 2009, likely due to the Great Recession and/or Prosper significantly changing its rate-setting model. I suspect that there will be important changes in the explanatory variables as a function of time. Mainly, however, I'm interested in being able to build a predictive model of good and poor borrowers.

### What other features in the dataset do you think will help support your 
###investigation into your feature(s) of interest?

The other variables are mostly useful in this investigation as well, particularly `CreditScoreMidpt`, `ListingCategory`, `StatedMonthlyIncome`, `DelinquenciesLast7Years`, `MonthlyLoanPayment`, `BorrowerRate`, and `EmploymentStatus`. Here are the major outcomes observed thus far:


### Did you create any new variables from existing variables in the dataset?

For the credit score data, I created `CreditScoreMidpt` in order to condense and simplify the data from `CreditScoreRangeUpper` and `CreditScoreRangeLower` by taking the midpoint between this pair of variables for each observation.

I also mapped the original numercially-coded `ListingCategory..numeric.` variable to a new variable `ListingCategory` that transforms the original numeric encoding into human-readable categories.

### Of the features you investigated, were there any unusual distributions? 
### Did you perform any operations on the data to tidy, adjust, or change the 
### form of the data? If so, why did you do this?

As stated earlier, there is a curious drop in loan activity in 2009 that I am going to investigate further. Other oddities I noted:

2. The loans largely have very high interest rates, with a surprisingly large number of loans taking an abnormally high value of APR and Rate, outside of the relatively smooth distribution of rates seen for the rest of the portfolio
7. Distribution of borrower credit scores is mostly normal and centered around 680, with some outliers near zero and and a small peak around 520 - 540.
8. The majority of borrowers (~67%) have no delinquencies in the last 7 years, but there are some who have 99 or more.
10. Monthly loan payments trend downward in frequency with increasing payment amount, not a surprising trend. However, they were multi-modal, indicating a variety of payments were particularly popular for some reason, trending from $200/month (the most popular) to \$1350/month

# Bivariate Plots Section

Let's start by doing a matrix of 2D plots to compare each variable to the others (I expect this to be VERY dense, but let's give it a go to see if there's anything unexpected). At this point, I feel comfortable ignoring 
`LenderYield`, `ListingCategory..numeric.`, and the upper and lower credit score range bounds. I've also had to remove a few other columns to make this graphic a bit 
less unwieldy, but we'll definitely be exploring more than what we see here.

```{r Many of the Bivariate_Plots Possible!}
library(GGally)
ggpairs(select(loans, LoanStatus, BorrowerRate,
               MonthlyLoanPayment, StatedMonthlyIncome, ListingCategory,
               CreditScoreMidpt),
        axisLabels = "internal",
        cardinality_threshold = 21)
```

Interesting! I'm not seeing some of the trends I was expecting (e.g. `BorrowerRate`
and `StatedMonthlyIncome` don't seem highly correlated), but there are some trends here
that are unexpected. For example: 

* Even though they have the highest correlation of these variable pairs, I expected more correlation for `CreditScoreMidPt` and `BorrowerRate` (r = -0.462).

* `MonthlyLoanPayment` and `Borrower Rate` have a highly unusual functional dependence and also show a low correlation (-0.245). I would have thought these would be more strongly correlated *and I certainly expected them to have a positive Pearson's r!* How odd. Since this is a highly nonlinear data set, we probably shouldn't take the r value too seriously...

* Here's one we should explore further: there's a *positive* correlation (0.293) between `MonthlyLoanPayment` and `CreditScoreMidPt`. But if a borrower's rate goes down as a function of increasing credit score, why would the payment increase with higher credit scores? This warrants further investigation. There appear to be some outlier data points causing some havoc with these results, so it will be good to filter those out.

There are a few other variable combinations that I expect intuitively will be interesting to investigate but that I couldn't fit into the `ggpairs` analysis, so we'll explore those individually.

But first things first: we have a to-do item lingering from our univariate analysis that we should address. `BorrowerState` showed some behavior that we wanted to explore further in this bivariate analysis section, so let's do that!

## Y vs. BorrowerState

Let's take a look at the relationship `BorrowerState` has with some of our other variables. As you will see frequently in this Bivariate Analysis section, our we will always take a look at the relationship each variable has with our outcome variable, `LoanStatus`. However, in order to better understand how other predictor variables interact with one another, we will at times plot those instead. Let's see what falls out!

First, we'll reproduce our simple counts of loans over states from earlier.

### Borrower State Loans Per Capita

```{r Distribution of BorrowerStates Redux}
ggplot(aes(x = BorrowerState), data = loans) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))
```

As seen earlier, CA, TX, NY, FL, and IL dominate these results. But what if we account for the populations of these states? What is the Prosper Loan per capita number for each state? After all, that's the more relevant measure here: what state has the greatest percentage of its population interested in Prosper loans? Is it a state like CA that loves new software platforms, or somewhere else?

```{r Normalizing Loan Counts by State Population}
library(dplyr)
state_pops <- read.csv("Data/Population Estimates by State.csv",
                     as.is = c(TRUE, TRUE))
state_abbrevs <- read.csv("Data/State_Abbrevs.csv", 
                          col.names = c("State", "Abbreviation"),
                          as.is = c(TRUE, TRUE),
                          strip.white = TRUE,
                          header = FALSE)
#Have to remove the commas from the Population data values and convert them
# from string to numeric values
state_pops$Population <- as.numeric(gsub(",","",state_pops$Population))

#Now let's join the state_pops and state_abbrevs dfs to make one population df
#That also includes abbreviated state names
state_pops <- left_join(state_pops, state_abbrevs, by = c("State" = "State"))

#Now we join the state_pops df with loans
loans <- left_join(loans, select(state_pops, Population, Abbreviation), 
                   by = c("BorrowerState" = "Abbreviation"))
```

```{r Loans Per Capita by Borrower State}
ggplot(aes(x = BorrowerState), data = loans) +
  geom_bar(aes(weight = 1/Population)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))
```

Well look at that! Indeed, we see that the leading states are no longer the ones we had originally identified. On a loans per capita measure, DC actually leads the pack, oddly enough. It's followed by GA, MD, IL, and OR. Well this blows any theories I may have had out of the water. I wonder if this is purely a function of the limiting of what states could participate in the marketplace after 2009? Or perhaps it has something to do with people in those states living more paycheck-to-paycheck and needing loans to make ends meet? This would likely be reflected in their credit score, so we can check that out too.

### BorrowerState and ListingDate



### BorrowerState and Credit Score



### BorrowerState and LoanStatus




# Bivariate Analysis

> **Tip**: As before, summarize what you found in your bivariate explorations
here. Use the questions below to guide your discussion.

### Talk about some of the relationships you observed in this part of the \
investigation. How did the feature(s) of interest vary with other features in \
the dataset?

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

### What was the strongest relationship you found?


# Multivariate Plots Section

> **Tip**: Now it's time to put everything together. Based on what you found in
the bivariate plots section, create a few multivariate plots to investigate
more complex interactions between variables. Make sure that the plots that you
create here are justified by the plots you explored in the previous section. If
you plan on creating any mathematical models, this is the section where you
will do that.

```{r echo=FALSE, Multivariate_Plots}

```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. Were there features that strengthened each other in terms of \
looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the \
strengths and limitations of your model.

------

# Final Plots and Summary

> **Tip**: You've done a lot of exploration and have built up an understanding
of the structure of and relationships between the variables in your dataset.
Here, you will select three plots from all of your previous exploration to
present here as a summary of some of your most interesting findings. Make sure
that you have refined your selected plots for good titling, axis labels (with
units), and good aesthetic choices (e.g. color, transparency). After each plot,
make sure you justify why you chose each plot by describing what it shows.

### Plot One
```{r echo=FALSE, Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

```

### Description Three

------

# Reflection

> **Tip**: Here's the final step! Reflect on the exploration you performed and
the insights you found. What were some of the struggles that you went through?
What went well? What was surprising? Make sure you include an insight into
future work that could be done with the dataset.

> **Tip**: Don't forget to remove this, and the other **Tip** sections before
saving your final work and knitting the final report!